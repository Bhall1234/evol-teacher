<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Learning Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            overflow: hidden; /* Prevent scrolling when popup is active */
        }
        .container {
            display: flex;
            max-width: 1200px;
            margin: auto;
            gap: 20px;
            opacity: 0.2; /* Make content dim while popup is active */
            pointer-events: none; /* Disable interaction with content while popup is active */
            max-height: none;
            overflow: auto;
        }
        .column {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
        }
        .code-block {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .CodeMirror {
            border: 1px solid #ddd;
            height: auto;
            width: 100%;
        }
        .response {
            white-space: pre-wrap;
            margin: 0;
            padding: 0;
        }
        p, h2 {
            margin: 0;
            padding: 0;
        }
        .buttons {
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .run-button {
            background-color: #4CAF50;
            color: white;
        }
        .run-button:hover {
            background-color: #45a049;
        }
        .reset-button {
            background-color: #f44336;
            color: white;
        }
        .reset-button:hover {
            background-color: #e53935;
        }
        .hint-button, .explanation-button, .check-button, .solution-button {
            background-color: #008CBA;
            color: white;
            padding: 10px 20px;
            margin-top: 10px;
        }
        .hint-button:hover, .explanation-button:hover, .check-button:hover, .solution-button:hover {
            background-color: #007bb5;
        }
        .check-button {
            margin-top: 10px;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            white-space: pre-wrap;
            margin: 0;
            overflow: auto;
        }
        code {
            white-space: pre-wrap;
        }
        .highlight pre {
            margin: 0;
            padding: 10px;
            white-space: pre-wrap;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        input[type="submit"] {
            width: fit-content;
            padding: 10px 20px;
            align-self: flex-start;
        }
        #check-result {
            font-size: 1.2em;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f8f8f8;
        }

        /* Popup Styling */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            max-width: 500px;
            box-sizing: border-box;
        }
        .popup-content h2 {
            margin-bottom: 10px;
        }
        .popup-content p {
            margin-bottom: 20px;
        }
        .popup-content button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
        }
        /* Loading Overlay Styles */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Ensures the overlay is on top */
        }

        /* Spinner Styles */
        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        /* Animation for the Spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Disclaimer Popup -->
    <div class="popup" id="disclaimer-popup">
        <div class="popup-content">
            <h2>Disclaimer</h2>
            <p>Please note that the content presented by this chatbot does not represent my views or the views of the University of Nottingham.</p>
            <p>By continuing, you acknowledge that the information provided is for educational purposes only.</p>
            <button onclick="closePopup()">I Understand</button>
        </div>
    </div>
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
    <div class="container" id="content-container">
        <div class="column">
            <h1>Interactive Python Learning Environment</h1>
            <form method="POST" action="/ask" id="ask-form">
                <label for="question">Ask a question about Python:</label><br>
                <!-- Drop-down menu for predefined questions -->
                <select id="predefined-question" name="predefined_question" onchange="toggleTextInput()">
                    <option value="">--Select a question--</option>
                    <option value="What are some of the basic concepts in Python that I should know about?">What are some of the basic concepts in Python that I should know about?</option>
                    <option value="What is a variable in Python?">What is a variable in Python?</option>
                    <option value="What are the different types of data in Python?">What are the different types of data in Python?</option>
                    <option value="How do I add numbers together in Python?">How do I add numbers together in Python?</option>
                </select>
                <!-- OR separator -->
                <p>OR</p>
                <!-- Text input for custom question -->
                <input type="text" id="question" name="question" placeholder="Type your own question here...">
                <input type="submit" value="Submit">
            </form>
            <br>
            {% if question %}
            <h2>Your Question:</h2>
            <p>{{ question }}</p>
            <h2>Response:</h2>
            <div id="response" class="response">
                {% if explanation %}
                {{ explanation | safe }}
                {% else %}
                <p class="loading">Processing your question...</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="column">
            {% if incorrect_code %}
            <h2>Incorrect Code:</h2>
            <p><strong>Task Description:</strong> {{ task_description }}</p>
            <div class="code-block">{{ incorrect_code | safe }}</div>
            <p id="hint" style="display: none;"><strong>Hint:</strong> {{ hint }}</p>
            <p id="explanation" style="display: none;"><strong>Explanation:</strong> {{ detailed_explanation }}</p>
            {% endif %}
            <h2>Try to Fix the Incorrect Code:</h2>
            <textarea id="editor"></textarea>
            <pre id="output"></pre>
            <div class="buttons">
                <button class="run-button" onclick="runCode()">Run Code</button>
                <button class="reset-button" onclick="resetCode()">Reset Code</button>
                <button class="hint-button" onclick="toggleHint()">Show Hint</button>
                <button class="explanation-button" onclick="toggleExplanation()">Show Explanation</button>
                <button class="solution-button" onclick="toggleSolution()">Show Solution</button>
            </div>
            <form id="check-code-form">
                <input type="hidden" id="task-id" name="task_id" value="{{ task_id }}">
                <button type="submit" class="check-button">Check Code</button>
            </form>
            <div id="check-result"></div>

            <!-- Static Analysis and Code Completion Sections -->
            <div id="static-analysis" style="margin-top: 10px;">
                <h3>Code Analysis Results:</h3>
                <pre id="static-analysis-result"></pre>
            </div>

            {% if correct_code %}
            <div id="solution" style="display: none;">
                <h2>Correct Code:</h2>
                <div class="code-block">{{ correct_code | safe }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- New column for chat interaction -->
    <div class="column" id="chat-column">
        <h2>Chat with Assistant</h2>
        <div id="chatbox" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f8f8f8;"></div>
        <input type="text" id="chat-input" placeholder="Ask about the code..." style="width: calc(100% - 40px); padding: 10px; margin-top: 10px;">
        <button onclick="sendMessage()" style="width: 100%; padding: 10px; background-color: #4CAF50; color: white; margin-top: 10px;">Send</button>
    </div>
    <div class="column" id="reflection-chat-column" style="display: none;">
        <h2>Reflect on Your Solution</h2>
        <div id="reflection-chatbox" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f8f8f8;"></div>
        <input type="text" id="reflection-chat-input" placeholder="Explain why your solution works..." style="width: calc(100% - 40px); padding: 10px; margin-top: 10px;">
        <button onclick="sendReflectionMessage()" style="width: 100%; padding: 10px; background-color: #4CAF50; color: white; margin-top: 10px;">Send</button>
    </div>
    
    <script>
        function toggleTextInput() {
            var predefinedQuestion = document.getElementById("predefined-question").value;
            var questionInput = document.getElementById("question");
    
            // If a predefined question is selected, disable the text input
            if (predefinedQuestion) {
                questionInput.disabled = true;
                questionInput.value = "";  // Clear the input if a predefined question is chosen
            } else {
                questionInput.disabled = false;
            }
        }
    </script>

    <script>
        var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
            lineNumbers: true,
            mode: "python",
            theme: "default"
        });

        function toggleHint() {
            var hint = document.getElementById("hint");
            if (hint.style.display === "none") {
                hint.style.display = "block";
            } else {
                hint.style.display = "none";
            }
        }

        function toggleExplanation() {
            var explanation = document.getElementById("explanation");
            if (explanation.style.display === "none") {
                explanation.style.display = "block";
            } else {
                explanation.style.display = "none";
            }
        }

        function toggleSolution() {
            var solution = document.getElementById("solution");
            if (solution.style.display === "none") {
                solution.style.display = "block";
            } else {
                solution.style.display = "none";
            }
        }

        function runCode() {
            var code = editor.getValue();
            var outputElement = document.getElementById("output");
            outputElement.textContent = "Running code...\n";

            fetch("/run_code", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                outputElement.textContent = data.output || "No output received.";
            })
            .catch(error => {
                outputElement.textContent = "Error running code.";
                console.error("Error:", error);
            });
        }

        function resetCode() {
            editor.setValue("");
        }

        document.getElementById("check-code-form").addEventListener("submit", function(event) {
            event.preventDefault();
            
            var userCode = editor.getValue();
            var taskId = document.getElementById("task-id").value;

            // Show the loading overlay
            document.getElementById("loading-overlay").style.display = "flex";
            
            fetch("/interact", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ code: userCode, task_id: taskId })
            })
            .then(response => response.json())
            .then(data => {
                var resultElement = document.getElementById("check-result");
                var reflectionChatColumn = document.getElementById("reflection-chat-column");

                if (data.result === "Correct") {
                    resultElement.innerText = "Great job! Your code is correct.";
                    resultElement.style.color = "green";

                    // Show the reflection chat column
                    reflectionChatColumn.style.display = "block";
                    
                    // Add the reflection question to the reflection chatbox
                    var chatbox = document.getElementById("reflection-chatbox");

                    // Ensure you're accessing the correct key from the JSON response
                    if (data.initial_chat_message) {
                        chatbox.innerHTML += "<p><strong>Assistant:</strong> " + data.initial_chat_message + "</p>";
                    } else {
                        chatbox.innerHTML += "<p><strong>Assistant:</strong> Error: No reflection question generated.</p>";
                    }

                } else {
                    resultElement.innerText = "Oops! There seems to be an error in your code.";
                    resultElement.style.color = "red";
                }

                var staticAnalysisElement = document.getElementById("static-analysis-result");
                staticAnalysisElement.textContent = data.static_analysis;

                // Hide the loading overlay
                document.getElementById("loading-overlay").style.display = "none";
            })
            .catch(error => {
                console.error("Error:", error);
                // Hide the loading overlay in case of an error
                document.getElementById("loading-overlay").style.display = "none";
            });
        });

        function sendMessage() {
            var message = document.getElementById("chat-input").value;
            var chatbox = document.getElementById("chatbox");
            var taskId = document.getElementById("task-id").value;

            // Add the user's message to the chatbox
            chatbox.innerHTML += "<p><strong>You:</strong> " + message + "</p>";
            document.getElementById("chat-input").value = ""; // Clear the input box

            // Show the loading overlay
            document.getElementById("loading-overlay").style.display = "flex";

            fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "message=" + encodeURIComponent(message) + "&task_id=" + taskId
            })
            .then(response => response.json())
            .then(data => {
                chatbox.innerHTML += "<p><strong>Assistant:</strong> " + data.response + "</p>";
                chatbox.scrollTop = chatbox.scrollHeight; // Scroll to the bottom

                // Hide the loading overlay
                document.getElementById("loading-overlay").style.display = "none";
            });
        }

        function sendReflectionMessage() {
            var message = document.getElementById("reflection-chat-input").value;
            var chatbox = document.getElementById("reflection-chatbox");
            var taskId = document.getElementById("task-id").value;

            // Add the user's message to the chatbox
            chatbox.innerHTML += "<p><strong>You:</strong> " + message + "</p>";
            document.getElementById("reflection-chat-input").value = ""; // Clear the input box

            // Show the loading overlay
            document.getElementById("loading-overlay").style.display = "flex";

            fetch("/interact", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: message, task_id: taskId })
            })
            .then(response => response.json())
            .then(data => {
                chatbox.innerHTML += "<p><strong>Assistant:</strong> " + data.response + "</p>";
                chatbox.scrollTop = chatbox.scrollHeight; // Scroll to the bottom

                // Hide the loading overlay
                document.getElementById("loading-overlay").style.display = "none";
            });
        }

        // Function to close the popup and store a cookie
        function closePopup() {
            setCookie('disclaimer_acknowledged', 'true', 30); // Store cookie for 30 days
            var popup = document.getElementById("disclaimer-popup");
            var content = document.getElementById("content-container");
            popup.style.display = "none";
            content.style.opacity = "1";
            content.style.pointerEvents = "auto";
            document.body.style.overflow = "auto"; // Re-enable scrolling
        }

        // Function to set a cookie
        function setCookie(name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        // Function to get a cookie
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Check if the user has already acknowledged the disclaimer
        window.onload = function() {
            var disclaimerAcknowledged = getCookie('disclaimer_acknowledged');
            if (disclaimerAcknowledged) {
                var popup = document.getElementById("disclaimer-popup");
                var content = document.getElementById("content-container");
                popup.style.display = "none";
                content.style.opacity = "1";
                content.style.pointerEvents = "auto";
                document.body.style.overflow = "auto"; // Re-enable scrolling
            }
        };
    </script>
</body>
</html>
